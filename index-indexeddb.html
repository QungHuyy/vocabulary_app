<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng dụng từ vựng - IndexedDB Version</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Storage Status Banner -->
    <div id="storageStatus" class="storage-status">
        <div class="storage-info">
            <i class="fas fa-database"></i>
            <span id="storageText">Đang khởi tạo hệ thống lưu trữ...</span>
            <button id="storageDetailsBtn" class="btn-link" style="display: none;">Chi tiết</button>
        </div>
    </div>

    <div class="container">
        <header>
            <h1><i class="fas fa-book"></i> Ứng dụng từ vựng</h1>
            <div class="storage-badge">
                <i class="fas fa-server"></i>
                <span id="storageBadge">IndexedDB Ready</span>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="tabs">
            <button class="tab-btn active" data-tab="lessons">
                <i class="fas fa-graduation-cap"></i> Bài học
            </button>
            <button class="tab-btn" data-tab="add-word">
                <i class="fas fa-plus"></i> Thêm từ
            </button>
            <button class="tab-btn" data-tab="word-list">
                <i class="fas fa-list"></i> Danh sách từ
            </button>
            <button class="tab-btn" data-tab="practice">
                <i class="fas fa-dumbbell"></i> Luyện tập
            </button>
            <button class="tab-btn" data-tab="quiz">
                <i class="fas fa-question-circle"></i> Quiz
            </button>
            <button class="tab-btn" data-tab="review">
                <i class="fas fa-eye"></i> Ôn tập
            </button>
            <button class="tab-btn" data-tab="backup">
                <i class="fas fa-archive"></i> Backup
            </button>
        </nav>

        <!-- Lessons Tab -->
        <div class="tab-content active" id="lessons">
            <div class="card">
                <h2><i class="fas fa-graduation-cap"></i> Quản lý bài học</h2>
                
                <div class="current-lesson">
                    <h3>Bài học hiện tại:</h3>
                    <div id="currentLessonDisplay">
                        <span class="no-lesson">Chưa chọn bài học</span>
                    </div>
                </div>

                <div class="lesson-actions">
                    <button id="createLessonBtn" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Tạo bài học mới
                    </button>
                </div>

                <div id="createLessonForm" class="form-section" style="display: none;">
                    <h3>Tạo bài học mới</h3>
                    <form id="addLessonForm">
                        <div class="form-group">
                            <label for="lessonName">Tên bài học:</label>
                            <input type="text" id="lessonName" required maxlength="100">
                        </div>
                        <div class="form-group">
                            <label for="lessonDescription">Mô tả:</label>
                            <textarea id="lessonDescription" rows="3" maxlength="500"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="lessonColor">Màu sắc:</label>
                            <select id="lessonColor" required>
                                <option value="blue">Xanh dương</option>
                                <option value="green">Xanh lá</option>
                                <option value="red">Đỏ</option>
                                <option value="purple">Tím</option>
                                <option value="orange">Cam</option>
                                <option value="pink">Hồng</option>
                            </select>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Lưu bài học
                            </button>
                            <button type="button" id="cancelLessonBtn" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Hủy
                            </button>
                        </div>
                    </form>
                </div>

                <div class="lessons-list">
                    <h3>Danh sách bài học:</h3>
                    <div id="lessonsList">
                        <!-- Lessons will be rendered here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Word Tab -->
        <div class="tab-content" id="add-word">
            <div class="card">
                <h2><i class="fas fa-plus"></i> Thêm từ vựng mới</h2>
                
                <form id="addWordForm">
                    <div class="form-group">
                        <label for="englishWord">Từ tiếng Anh:</label>
                        <div class="input-with-suggestions">
                            <input type="text" id="englishWord" required maxlength="100">
                            <div id="englishSuggestions" class="suggestions-container"></div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="vietnameseWord">Nghĩa tiếng Việt:</label>
                        <input type="text" id="vietnameseWord" required maxlength="200">
                        <div id="translationResult" class="translation-result"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="wordExample">Ví dụ:</label>
                        <textarea id="wordExample" rows="3" maxlength="500" placeholder="Nhập câu ví dụ (không bắt buộc)"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="wordCategory">Phân loại:</label>
                        <select id="wordCategory" required>
                            <option value="">Chọn phân loại</option>
                            <option value="noun">Danh từ (Noun)</option>
                            <option value="verb">Động từ (Verb)</option>
                            <option value="adjective">Tính từ (Adjective)</option>
                            <option value="adverb">Trạng từ (Adverb)</option>
                            <option value="preposition">Giới từ (Preposition)</option>
                            <option value="conjunction">Liên từ (Conjunction)</option>
                            <option value="phrase">Cụm từ (Phrase)</option>
                            <option value="other">Khác</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="wordLesson">Bài học:</label>
                        <select id="wordLesson" required>
                            <option value="">Chọn bài học</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Thêm từ vựng
                    </button>
                </form>
            </div>
        </div>

        <!-- Word List Tab -->
        <div class="tab-content" id="word-list">
            <div class="card">
                <h2><i class="fas fa-list"></i> Danh sách từ vựng</h2>
                
                <!-- Filters -->
                <div class="filters">
                    <div class="filter-group">
                        <label for="searchWord">Tìm kiếm:</label>
                        <input type="text" id="searchWord" placeholder="Tìm từ tiếng Anh hoặc tiếng Việt...">
                    </div>
                    <div class="filter-group">
                        <label for="filterCategory">Phân loại:</label>
                        <select id="filterCategory">
                            <option value="">Tất cả</option>
                            <option value="noun">Danh từ</option>
                            <option value="verb">Động từ</option>
                            <option value="adjective">Tính từ</option>
                            <option value="adverb">Trạng từ</option>
                            <option value="preposition">Giới từ</option>
                            <option value="conjunction">Liên từ</option>
                            <option value="phrase">Cụm từ</option>
                            <option value="other">Khác</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filterLesson">Bài học:</label>
                        <select id="filterLesson">
                            <option value="">Tất cả</option>
                        </select>
                    </div>
                </div>
                
                <!-- Word List -->
                <div id="wordsList" class="words-list">
                    <!-- Words will be rendered here -->
                </div>
            </div>
        </div>

        <!-- Practice Tab -->
        <div class="tab-content" id="practice">
            <div class="card">
                <div id="practiceSelector" class="practice-selector">
                    <h2><i class="fas fa-dumbbell"></i> Chế độ luyện tập</h2>
                    <p>Chọn phương pháp luyện tập phù hợp với bạn:</p>
                    
                    <div class="practice-modes">
                        <div class="practice-mode-card" onclick="app.selectPracticeMode('flashcards')">
                            <i class="fas fa-id-card"></i>
                            <h3>Flashcards</h3>
                            <p>Lật thẻ từ vựng với hiệu ứng 3D</p>
                        </div>
                        
                        <div class="practice-mode-card" onclick="app.selectPracticeMode('spelling')">
                            <i class="fas fa-keyboard"></i>
                            <h3>Spelling Test</h3>
                            <p>Nghe và viết chính tả từ</p>
                        </div>
                        
                        <div class="practice-mode-card" onclick="app.selectPracticeMode('matching')">
                            <i class="fas fa-arrows-alt-h"></i>
                            <h3>Matching Game</h3>
                            <p>Ghép từ tiếng Anh với nghĩa tiếng Việt</p>
                        </div>
                        
                        <div class="practice-mode-card" onclick="app.selectPracticeMode('speed')">
                            <i class="fas fa-stopwatch"></i>
                            <h3>Speed Challenge</h3>
                            <p>Trả lời nhanh trong thời gian giới hạn</p>
                        </div>
                        
                        <div class="practice-mode-card" onclick="app.selectPracticeMode('listening')">
                            <i class="fas fa-headphones"></i>
                            <h3>Listening Practice</h3>
                            <p>Nghe và chọn nghĩa đúng</p>
                        </div>
                        
                        <div class="practice-mode-card" onclick="app.selectPracticeMode('quiz')">
                            <i class="fas fa-question-circle"></i>
                            <h3>Enhanced Quiz</h3>
                            <p>Quiz với nhiều chế độ khác nhau</p>
                        </div>
                    </div>
                </div>

                <!-- Practice Mode Containers will be added dynamically -->
                <div id="flashcardsContainer" class="practice-container" style="display: none;">
                    <!-- Flashcards content will be rendered here -->
                </div>
                
                <div id="spellingContainer" class="practice-container" style="display: none;">
                    <!-- Spelling test content will be rendered here -->
                </div>
                
                <div id="matchingContainer" class="practice-container" style="display: none;">
                    <!-- Matching game content will be rendered here -->
                </div>
                
                <div id="speedContainer" class="practice-container" style="display: none;">
                    <!-- Speed challenge content will be rendered here -->
                </div>
                
                <div id="listeningContainer" class="practice-container" style="display: none;">
                    <!-- Listening practice content will be rendered here -->
                </div>
            </div>
        </div>

        <!-- Quiz Tab -->
        <div class="tab-content" id="quiz">
            <div class="card">
                <h2><i class="fas fa-question-circle"></i> Quiz từ vựng</h2>
                
                <div id="quizStart" class="quiz-start">
                    <div class="quiz-settings">
                        <h3>Cài đặt Quiz:</h3>
                        <div class="setting-group">
                            <label for="quizMode">Chế độ:</label>
                            <select id="quizMode">
                                <option value="en-vi">Tiếng Anh → Tiếng Việt</option>
                                <option value="vi-en">Tiếng Việt → Tiếng Anh</option>
                                <option value="mixed">Xáo trộn</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="lesson-selection">
                        <h3>Chọn bài học:</h3>
                        <div class="lesson-checkboxes">
                            <div class="lesson-controls">
                                <button class="btn btn-sm" onclick="app.selectAllLessons()">Chọn tất cả</button>
                                <button class="btn btn-sm" onclick="app.deselectAllLessons()">Bỏ chọn tất cả</button>
                            </div>
                            <div id="reviewLessonCheckboxes">
                                <!-- Lesson checkboxes will be rendered here -->
                            </div>
                            <div id="reviewSelectedInfo" class="selected-info">
                                <!-- Selected lesson info will be shown here -->
                            </div>
                        </div>
                    </div>
                    
                    <button id="startQuiz" class="btn btn-primary">
                        <i class="fas fa-play"></i> Bắt đầu Quiz
                    </button>
                </div>
                
                <div id="quizContent" style="display: none;">
                    <!-- Quiz content will be rendered here -->
                </div>
            </div>
        </div>

        <!-- Review Tab -->
        <div class="tab-content" id="review">
            <div class="card">
                <h2><i class="fas fa-eye"></i> Ôn tập từ vựng</h2>
                
                <div id="reviewStart">
                    <button id="startReview" class="btn btn-primary">
                        <i class="fas fa-play"></i> Bắt đầu ôn tập
                    </button>
                    <button id="shuffleReview" class="btn btn-secondary">
                        <i class="fas fa-random"></i> Trộn ngẫu nhiên
                    </button>
                </div>
                
                <div id="reviewContent" style="display: none;">
                    <!-- Review content will be rendered here -->
                </div>
            </div>
        </div>

        <!-- Backup Tab -->
        <div class="tab-content" id="backup">
            <div class="card">
                <h2><i class="fas fa-archive"></i> Backup & Restore</h2>
                
                <!-- Storage Information -->
                <div class="storage-info-section">
                    <h3><i class="fas fa-info-circle"></i> Thông tin lưu trữ</h3>
                    <div id="storageInfoDisplay">
                        <div class="info-loading">
                            <i class="fas fa-spinner fa-spin"></i> Đang tải thông tin...
                        </div>
                    </div>
                </div>

                <!-- Export/Import -->
                <div class="backup-section">
                    <h3><i class="fas fa-download"></i> Xuất dữ liệu</h3>
                    <p>Tạo file backup để lưu trữ an toàn dữ liệu của bạn.</p>
                    
                    <div class="backup-actions">
                        <button onclick="exportData()" class="btn btn-primary">
                            <i class="fas fa-download"></i> Xuất dữ liệu (JSON)
                        </button>
                        <button id="createBackupBtn" class="btn btn-success">
                            <i class="fas fa-plus"></i> Tạo Backup tự động
                        </button>
                    </div>
                </div>

                <div class="backup-section">
                    <h3><i class="fas fa-upload"></i> Nhập dữ liệu</h3>
                    <p>Restore dữ liệu từ file backup đã xuất trước đó.</p>
                    
                    <input type="file" id="importFile" accept=".json" onchange="importData(event)" style="display: none;">
                    <button onclick="document.getElementById('importFile').click()" class="btn btn-secondary">
                        <i class="fas fa-upload"></i> Chọn file để nhập
                    </button>
                </div>

                <!-- Auto Backups (IndexedDB only) -->
                <div class="backup-section">
                    <h3><i class="fas fa-history"></i> Backup tự động</h3>
                    <div id="autoBackupsList">
                        <div class="loading">
                            <i class="fas fa-spinner fa-spin"></i> Đang tải danh sách backup...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics -->
        <div id="stats" class="stats">
            <div class="stat-item">
                <i class="fas fa-book"></i>
                <span>Từ vựng: <span id="totalWords">0</span></span>
            </div>
            <div class="stat-item">
                <i class="fas fa-graduation-cap"></i>
                <span>Bài học: <span id="totalLessons">0</span></span>
            </div>
            <div class="stat-item">
                <i class="fas fa-chart-line"></i>
                <span>Đã học: <span id="learnedWords">0</span></span>
            </div>
            <div class="stat-item">
                <i class="fas fa-percentage"></i>
                <span>Tỷ lệ đúng: <span id="accuracy">0%</span></span>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <h3>Xác nhận xóa</h3>
            <p>Bạn có chắc chắn muốn xóa mục này không?</p>
            <div class="modal-actions">
                <button id="confirmDelete" class="btn btn-danger">Xóa</button>
                <button onclick="app.hideModal()" class="btn btn-secondary">Hủy</button>
            </div>
        </div>
    </div>

    <!-- Storage Details Modal -->
    <div id="storageModal" class="modal">
        <div class="modal-content">
            <h3><i class="fas fa-database"></i> Chi tiết lưu trữ</h3>
            <div id="storageModalContent">
                <!-- Storage details will be loaded here -->
            </div>
            <div class="modal-actions">
                <button onclick="closeStorageModal()" class="btn btn-secondary">Đóng</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Import storage modules
        import('./src/js/core/storage-adapter.js').then(({ default: StorageAdapter }) => {
            window.StorageAdapter = StorageAdapter;
        });
    </script>
    
    <script src="script.js"></script>
    
    <script>
        // Enhanced export/import functions for IndexedDB
        async function exportData() {
            try {
                if (window.app && window.app.storage) {
                    const data = await window.app.storage.exportData();
                    
                    const dataStr = JSON.stringify(data, null, 2);
                    const dataBlob = new Blob([dataStr], {type: 'application/json'});
                    
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(dataBlob);
                    link.download = `vocabulary_backup_${new Date().toISOString().split('T')[0]}.json`;
                    link.click();
                    
                    app.showMessage('Xuất dữ liệu thành công!', 'success');
                } else {
                    // Fallback to old method
                    const data = {
                        words: app.words,
                        lessons: app.lessons,
                        progress: app.quizProgress,
                        exportDate: new Date().toISOString()
                    };
                    
                    const dataStr = JSON.stringify(data, null, 2);
                    const dataBlob = new Blob([dataStr], {type: 'application/json'});
                    
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(dataBlob);
                    link.download = `vocabulary_backup_${new Date().toISOString().split('T')[0]}.json`;
                    link.click();
                }
            } catch (error) {
                console.error('Export failed:', error);
                app.showMessage('Lỗi khi xuất dữ liệu!', 'error');
            }
        }

        async function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (window.app && window.app.storage) {
                        await window.app.storage.importData(data);
                        
                        // Reload app data
                        await app.loadDataFromStorage();
                        app.updateStats();
                        app.renderWordsList();
                        app.renderLessonsList();
                        app.updateLessonSelectors();
                        
                        app.showMessage('Nhập dữ liệu thành công!', 'success');
                    } else {
                        // Fallback to old method
                        if (data.words && Array.isArray(data.words)) {
                            app.words = data.words;
                            if (data.lessons) {
                                app.lessons = data.lessons;
                            }
                            if (data.progress) {
                                app.quizProgress = data.progress;
                            }
                            
                            app.saveToStorage();
                            app.updateStats();
                            app.renderWordsList();
                            app.renderLessonsList();
                            app.updateLessonSelectors();
                            app.showMessage('Đã nhập dữ liệu thành công!', 'success');
                        } else {
                            app.showMessage('File không đúng định dạng!', 'error');
                        }
                    }
                } catch (error) {
                    console.error('Import error:', error);
                    app.showMessage('Lỗi khi đọc file!', 'error');
                }
            };
            reader.readAsText(file);
        }

        // Storage modal functions
        function closeStorageModal() {
            document.getElementById('storageModal').style.display = 'none';
        }

        // Initialize storage status display
        document.addEventListener('DOMContentLoaded', function() {
            const storageDetailsBtn = document.getElementById('storageDetailsBtn');
            const createBackupBtn = document.getElementById('createBackupBtn');
            
            if (storageDetailsBtn) {
                storageDetailsBtn.addEventListener('click', async function() {
                    if (window.app && window.app.storage) {
                        try {
                            const info = await window.app.storage.getStorageInfo();
                            const modal = document.getElementById('storageModal');
                            const content = document.getElementById('storageModalContent');
                            
                            content.innerHTML = `
                                <div class="storage-details">
                                    <div class="detail-item">
                                        <strong>Loại lưu trữ:</strong> ${info.type}
                                    </div>
                                    <div class="detail-item">
                                        <strong>Trạng thái:</strong> ${info.isReady ? 'Sẵn sàng' : 'Chưa sẵn sàng'}
                                    </div>
                                    <div class="detail-item">
                                        <strong>Hỗ trợ IndexedDB:</strong> ${info.supportsIndexedDB ? 'Có' : 'Không'}
                                    </div>
                                    ${info.stats ? `
                                        <div class="detail-item">
                                            <strong>Số từ vựng:</strong> ${info.stats.words}
                                        </div>
                                        <div class="detail-item">
                                            <strong>Số bài học:</strong> ${info.stats.lessons}
                                        </div>
                                        <div class="detail-item">
                                            <strong>Số backup:</strong> ${info.stats.backups}
                                        </div>
                                    ` : ''}
                                    ${info.usage ? `
                                        <div class="detail-item">
                                            <strong>Dung lượng đã dùng:</strong> ${info.usage.usedBytes ? (info.usage.usedBytes / 1024).toFixed(2) + ' KB' : 'N/A'}
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                            
                            modal.style.display = 'block';
                        } catch (error) {
                            console.error('Failed to get storage info:', error);
                        }
                    }
                });
            }

            if (createBackupBtn) {
                createBackupBtn.addEventListener('click', async function() {
                    if (window.app && window.app.storage) {
                        try {
                            const description = prompt('Nhập mô tả cho backup (tùy chọn):') || 'Manual backup';
                            await window.app.storage.createBackup(description);
                            app.showMessage('Tạo backup thành công!', 'success');
                            loadAutoBackupsList(); // Refresh backup list
                        } catch (error) {
                            console.error('Failed to create backup:', error);
                            app.showMessage('Lỗi khi tạo backup!', 'error');
                        }
                    } else {
                        app.showMessage('Backup chỉ khả dụng với IndexedDB!', 'warning');
                    }
                });
            }
        });

        // Load auto backups list
        async function loadAutoBackupsList() {
            const container = document.getElementById('autoBackupsList');
            if (!container) return;

            try {
                if (window.app && window.app.storage) {
                    const backups = await window.app.storage.getAllBackups();
                    
                    if (backups.length === 0) {
                        container.innerHTML = '<p>Chưa có backup tự động nào.</p>';
                        return;
                    }

                    container.innerHTML = backups.map(backup => `
                        <div class="backup-item">
                            <div class="backup-info">
                                <strong>${backup.description}</strong>
                                <span class="backup-date">${new Date(backup.timestamp).toLocaleString('vi-VN')}</span>
                            </div>
                            <div class="backup-actions">
                                <button onclick="restoreBackup(${backup.id})" class="btn btn-sm btn-primary">
                                    <i class="fas fa-undo"></i> Khôi phục
                                </button>
                                <button onclick="deleteBackup(${backup.id})" class="btn btn-sm btn-danger">
                                    <i class="fas fa-trash"></i> Xóa
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<p>Backup tự động chỉ khả dụng với IndexedDB.</p>';
                }
            } catch (error) {
                container.innerHTML = '<p>Lỗi khi tải danh sách backup.</p>';
                console.error('Failed to load backups:', error);
            }
        }

        // Restore backup
        async function restoreBackup(backupId) {
            if (!confirm('Bạn có chắc chắn muốn khôi phục backup này? Dữ liệu hiện tại sẽ bị ghi đè.')) {
                return;
            }

            try {
                if (window.app && window.app.storage) {
                    const backups = await window.app.storage.getAllBackups();
                    const backup = backups.find(b => b.id === backupId);
                    
                    if (backup) {
                        await window.app.storage.importData(backup.data);
                        await app.loadDataFromStorage();
                        app.updateStats();
                        app.renderWordsList();
                        app.renderLessonsList();
                        app.updateLessonSelectors();
                        app.showMessage('Khôi phục backup thành công!', 'success');
                    }
                }
            } catch (error) {
                console.error('Failed to restore backup:', error);
                app.showMessage('Lỗi khi khôi phục backup!', 'error');
            }
        }

        // Delete backup
        async function deleteBackup(backupId) {
            if (!confirm('Bạn có chắc chắn muốn xóa backup này?')) {
                return;
            }

            try {
                if (window.app && window.app.storage) {
                    await window.app.storage.deleteBackup(backupId);
                    app.showMessage('Xóa backup thành công!', 'success');
                    loadAutoBackupsList(); // Refresh list
                }
            } catch (error) {
                console.error('Failed to delete backup:', error);
                app.showMessage('Lỗi khi xóa backup!', 'error');
            }
        }

        // Load backups when backup tab is shown
        document.addEventListener('DOMContentLoaded', function() {
            const backupTab = document.querySelector('[data-tab="backup"]');
            if (backupTab) {
                backupTab.addEventListener('click', function() {
                    setTimeout(loadAutoBackupsList, 100);
                });
            }
        });
    </script>
</body>
</html> 