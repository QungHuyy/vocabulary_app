<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>·ª®ng d·ª•ng h·ªçc t·ª´ v·ª±ng ti·∫øng Anh - IndexedDB</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-book"></i> H·ªçc t·ª´ v·ª±ng ti·∫øng Anh <span class="storage-badge">IndexedDB</span></h1>
            <div class="stats">
                <div class="stat-item">
                    <span class="stat-number" id="totalWords">0</span>
                    <span class="stat-label">T·ª´ v·ª±ng</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="learnedWords">0</span>
                    <span class="stat-label">ƒê√£ h·ªçc</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="accuracy">0%</span>
                    <span class="stat-label">ƒê·ªô ch√≠nh x√°c</span>
                </div>
                <div class="stat-item storage-info">
                    <span class="stat-number" id="storageType">...</span>
                    <span class="stat-label">Storage</span>
                </div>
            </div>
        </header>

        <!-- Migration Status Banner -->
        <div id="migrationBanner" class="migration-banner" style="display: none;">
            <div class="migration-content">
                <i class="fas fa-database"></i>
                <span id="migrationMessage">ƒêang kh·ªüi t·∫°o...</span>
                <div class="migration-progress">
                    <div id="migrationProgressBar" class="progress-bar"></div>
                </div>
            </div>
        </div>

        <nav class="tab-nav">
            <button class="tab-btn active" data-tab="lessons">
                <i class="fas fa-folder"></i> B√†i h·ªçc
            </button>
            <button class="tab-btn" data-tab="add">
                <i class="fas fa-plus"></i> Th√™m t·ª´
            </button>
            <button class="tab-btn" data-tab="list">
                <i class="fas fa-list"></i> Danh s√°ch
            </button>
            <button class="tab-btn" data-tab="quiz">
                <i class="fas fa-question-circle"></i> Luy·ªán t·∫≠p
            </button>
            <button class="tab-btn" data-tab="review">
                <i class="fas fa-eye"></i> √în t·∫≠p
            </button>
            <button class="tab-btn" data-tab="backup">
                <i class="fas fa-shield-alt"></i> Sao l∆∞u
            </button>
        </nav>

        <!-- Tab B√†i h·ªçc -->
        <div class="tab-content active" id="lessons-tab">
            <div class="card">
                <div class="lessons-header">
                    <h2><i class="fas fa-folder"></i> Qu·∫£n l√Ω b√†i h·ªçc</h2>
                    <button class="btn btn-primary" onclick="app.showCreateLessonForm()">
                        <i class="fas fa-plus"></i> T·∫°o b√†i h·ªçc m·ªõi
                    </button>
                </div>

                <!-- Form t·∫°o b√†i h·ªçc m·ªõi -->
                <div id="createLessonForm" class="lesson-form" style="display: none;">
                    <h3><i class="fas fa-plus-circle"></i> T·∫°o b√†i h·ªçc m·ªõi</h3>
                    <form id="addLessonForm">
                        <div class="form-group">
                            <label for="lessonName">T√™n b√†i h·ªçc:</label>
                            <input type="text" id="lessonName" required placeholder="VD: Gia ƒë√¨nh v√† b·∫°n b√®">
                        </div>
                        <div class="form-group">
                            <label for="lessonDescription">M√¥ t·∫£ (t√πy ch·ªçn):</label>
                            <textarea id="lessonDescription" placeholder="M√¥ t·∫£ ng·∫Øn v·ªÅ b√†i h·ªçc n√†y..." rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="lessonColor">M√†u ch·ªß ƒë·ªÅ:</label>
                            <select id="lessonColor">
                                <option value="blue">Xanh d∆∞∆°ng</option>
                                <option value="green">Xanh l√°</option>
                                <option value="purple">T√≠m</option>
                                <option value="orange">Cam</option>
                                <option value="red">ƒê·ªè</option>
                                <option value="pink">H·ªìng</option>
                            </select>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> T·∫°o b√†i h·ªçc
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="app.hideCreateLessonForm()">
                                <i class="fas fa-times"></i> H·ªßy
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Danh s√°ch b√†i h·ªçc -->
                <div id="lessonsList" class="lessons-list"></div>

                <!-- B√†i h·ªçc hi·ªán t·∫°i -->
                <div id="currentLessonInfo" class="current-lesson-info">
                    <div class="current-lesson-card">
                        <h3><i class="fas fa-book-open"></i> B√†i h·ªçc hi·ªán t·∫°i</h3>
                        <div id="currentLessonDisplay"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Th√™m t·ª´ v·ª±ng -->
        <div class="tab-content" id="add-tab">
            <div class="card">
                <h2><i class="fas fa-plus-circle"></i> Th√™m t·ª´ v·ª±ng m·ªõi</h2>
                <div id="currentLessonSelector" class="lesson-selector">
                    <label for="selectedLesson">Th√™m v√†o b√†i h·ªçc:</label>
                    <select id="selectedLesson">
                        <option value="">Ch·ªçn b√†i h·ªçc...</option>
                    </select>
                </div>
                <form id="addWordForm">
                    <div class="form-group">
                        <label for="englishWord">T·ª´ ti·∫øng Anh:</label>
                        <div class="input-with-button">
                            <div class="autocomplete-container">
                                <input type="text" id="englishWord" required placeholder="VD: beautiful" autocomplete="off">
                                <div class="autocomplete-suggestions" id="englishSuggestions"></div>
                            </div>
                            <button type="button" class="btn-pronunciation" onclick="app.speakWord(document.getElementById('englishWord').value)" title="Ph√°t √¢m">
                                <i class="fas fa-volume-up"></i>
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="vietnameseMeaning">Nghƒ©a ti·∫øng Vi·ªát:</label>
                        <div class="translation-container">
                            <input type="text" id="vietnameseMeaning" required placeholder="VD: xinh ƒë·∫πp">
                            <div class="translation-status" id="translationStatus"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="example">V√≠ d·ª• (t√πy ch·ªçn):</label>
                        <input type="text" id="example" placeholder="VD: She is very beautiful">
                    </div>
                    <div class="form-group">
                        <label for="category">Danh m·ª•c:</label>
                        <select id="category">
                            <option value="general">T·ªïng qu√°t</option>
                            <option value="adjective">T√≠nh t·ª´</option>
                            <option value="noun">Danh t·ª´</option>
                            <option value="verb">ƒê·ªông t·ª´</option>
                            <option value="adverb">Tr·∫°ng t·ª´</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> L∆∞u t·ª´ v·ª±ng
                    </button>
                </form>
            </div>
        </div>

        <!-- Tab Danh s√°ch t·ª´ v·ª±ng -->
        <div class="tab-content" id="list-tab">
            <div class="card">
                <div class="list-header">
                    <h2><i class="fas fa-list"></i> Danh s√°ch t·ª´ v·ª±ng</h2>
                    <div class="search-filter">
                        <select id="filterLesson">
                            <option value="">T·∫•t c·∫£ b√†i h·ªçc</option>
                        </select>
                        <input type="text" id="searchWord" placeholder="T√¨m ki·∫øm t·ª´ v·ª±ng...">
                        <select id="filterCategory">
                            <option value="">T·∫•t c·∫£ danh m·ª•c</option>
                            <option value="general">T·ªïng qu√°t</option>
                            <option value="adjective">T√≠nh t·ª´</option>
                            <option value="noun">Danh t·ª´</option>
                            <option value="verb">ƒê·ªông t·ª´</option>
                            <option value="adverb">Tr·∫°ng t·ª´</option>
                        </select>
                    </div>
                </div>
                <div id="wordsList" class="words-list"></div>
            </div>
        </div>

        <!-- Tab Luy·ªán t·∫≠p -->
        <div class="tab-content" id="quiz-tab">
            <div class="card">
                <div class="practice-header">
                    <h2><i class="fas fa-dumbbell"></i> Luy·ªán t·∫≠p t·ª´ v·ª±ng</h2>
                    <div class="practice-mode-selector">
                        <h3>Ch·ªçn ch·∫ø ƒë·ªô luy·ªán t·∫≠p:</h3>
                        <div class="practice-modes">
                            <div class="practice-mode-card" onclick="app.selectPracticeMode('quiz')">
                                <i class="fas fa-question-circle"></i>
                                <h4>Quiz</h4>
                                <p>Tr·∫Øc nghi·ªám t√πy ch·ªânh</p>
                            </div>
                            <div class="practice-mode-card" onclick="app.selectPracticeMode('flashcards')">
                                <i class="fas fa-clone"></i>
                                <h4>Flashcards</h4>
                                <p>L·∫≠t th·∫ª t·ª´ v·ª±ng</p>
                            </div>
                            <div class="practice-mode-card" onclick="app.selectPracticeMode('spelling')">
                                <i class="fas fa-spell-check"></i>
                                <h4>Spelling Test</h4>
                                <p>Ki·ªÉm tra ch√≠nh t·∫£</p>
                            </div>
                            <div class="practice-mode-card" onclick="app.selectPracticeMode('matching')">
                                <i class="fas fa-puzzle-piece"></i>
                                <h4>Matching Game</h4>
                                <p>Gh√©p t·ª´ theo v√°n</p>
                            </div>
                            <div class="practice-mode-card" onclick="app.selectPracticeMode('speed')">
                                <i class="fas fa-bolt"></i>
                                <h4>Speed Challenge</h4>
                                <p>Th·ª≠ th√°ch t·ªëc ƒë·ªô</p>
                            </div>
                            <div class="practice-mode-card" onclick="app.selectPracticeMode('listening')">
                                <i class="fas fa-headphones"></i>
                                <h4>Listening Practice</h4>
                                <p>Luy·ªán nghe t√πy ch·ªânh</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dynamic Practice Content -->
                <div id="practiceContainer" style="display: none;"></div>
            </div>
        </div>

        <!-- Tab √în t·∫≠p -->
        <div class="tab-content" id="review-tab">
            <div class="card">
                <h2><i class="fas fa-eye"></i> √în t·∫≠p t·ª´ v·ª±ng</h2>
                
                <!-- Ch·ªçn b√†i h·ªçc ƒë·ªÉ √¥n t·∫≠p -->
                <div class="review-lesson-selector">
                    <h3><i class="fas fa-check-square"></i> Ch·ªçn b√†i h·ªçc ƒë·ªÉ √¥n t·∫≠p</h3>
                    <div class="lesson-checkboxes" id="reviewLessonCheckboxes">
                        <!-- Checkboxes will be populated by JavaScript -->
                    </div>
                    <div class="select-all-controls">
                        <button type="button" class="btn btn-small btn-primary" onclick="app.selectAllLessons()">
                            <i class="fas fa-check-double"></i> Ch·ªçn t·∫•t c·∫£
                        </button>
                        <button type="button" class="btn btn-small btn-secondary" onclick="app.deselectAllLessons()">
                            <i class="fas fa-times"></i> B·ªè ch·ªçn t·∫•t c·∫£
                        </button>
                    </div>
                </div>

                <div class="review-controls">
                    <button id="startReview" class="btn btn-secondary">
                        <i class="fas fa-play"></i> B·∫Øt ƒë·∫ßu √¥n t·∫≠p
                    </button>
                    <button id="shuffleReview" class="btn btn-secondary">
                        <i class="fas fa-random"></i> X√°o tr·ªôn
                    </button>
                </div>
                <div id="reviewContent" class="review-content">
                    <p>Ch·ªçn b√†i h·ªçc v√† nh·∫•n "B·∫Øt ƒë·∫ßu √¥n t·∫≠p" ƒë·ªÉ xem l·∫°i t·ª´ v·ª±ng ƒë√£ h·ªçc</p>
                </div>
            </div>
        </div>

        <!-- Tab Sao l∆∞u -->
        <div class="tab-content" id="backup-tab">
            <div class="card">
                <h2><i class="fas fa-shield-alt"></i> Sao l∆∞u & Ph·ª•c h·ªìi d·ªØ li·ªáu</h2>
                
                <!-- Storage Info -->
                <div class="storage-info-panel">
                    <h3><i class="fas fa-info-circle"></i> Th√¥ng tin l∆∞u tr·ªØ</h3>
                    <div id="storageInfoDisplay" class="storage-stats">
                        <div class="loading">ƒêang t·∫£i...</div>
                    </div>
                </div>

                <!-- Backup Management -->
                <div class="backup-panel">
                    <h3><i class="fas fa-download"></i> T·∫°o sao l∆∞u</h3>
                    <div class="backup-controls">
                        <button class="btn btn-primary" onclick="app.createManualBackup()">
                            <i class="fas fa-save"></i> T·∫°o sao l∆∞u ngay
                        </button>
                        <button class="btn btn-secondary" onclick="app.exportData()">
                            <i class="fas fa-file-export"></i> Xu·∫•t file JSON
                        </button>
                    </div>
                    
                    <div class="backup-list">
                        <h4>Danh s√°ch sao l∆∞u t·ª± ƒë·ªông:</h4>
                        <div id="backupsList" class="backups-container">
                            <div class="loading">ƒêang t·∫£i...</div>
                        </div>
                    </div>
                </div>

                <!-- File Backup for GitHub Pages -->
                <div class="file-backup-panel">
                    <h3><i class="fas fa-file-download"></i> Backup File (GitHub Pages)</h3>
                    <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">
                        <i class="fas fa-info-circle"></i> D√†nh cho GitHub Pages - t·∫£i file backup ƒë·ªÉ tr√°nh m·∫•t d·ªØ li·ªáu
                    </p>
                    <div class="backup-controls">
                        <button class="btn btn-success" onclick="app.exportDataToFile()">
                            <i class="fas fa-download"></i> T·∫£i file backup (.json)
                        </button>
                        <button class="btn btn-info" onclick="app.createAutoBackup()">
                            <i class="fas fa-sync"></i> T·∫°o backup t·ª± ƒë·ªông
                        </button>
                    </div>
                    
                    <div class="auto-backup-status" style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                        <h4><i class="fas fa-shield-alt"></i> Tr·∫°ng th√°i Auto-backup:</h4>
                        <p id="autoBackupStatus">‚úÖ IndexedDB auto-backup ƒëang ho·∫°t ƒë·ªông (m·ªói 10 ph√∫t)</p>
                        <p style="font-size: 0.85em; color: #666;">
                            ‚Ä¢ <strong>IndexedDB:</strong> Backup t·ª± ƒë·ªông m·ªói 10 ph√∫t v√† khi tho√°t trang<br>
                            ‚Ä¢ <strong>L∆∞u tr·ªØ:</strong> Backup trong database IndexedDB (kh√¥ng m·∫•t khi F5)<br>
                            ‚Ä¢ <strong>D·ª± ph√≤ng:</strong> Gi·ªØ 5 b·∫£n backup auto g·∫ßn nh·∫•t<br>
                            ‚Ä¢ <strong>File backup:</strong> T·∫£i file .json ƒë·ªÉ backup l√¢u d√†i
                        </p>
                    </div>
                </div>

                <!-- Import Data -->
                <div class="import-panel">
                    <h3><i class="fas fa-upload"></i> Nh·∫≠p d·ªØ li·ªáu</h3>
                    <div class="import-controls">
                        <input type="file" id="importFileInput" accept=".json" style="display: none;" onchange="app.importData(event)">
                        <input type="file" id="importFileBackup" accept=".json" style="display: none;" onchange="app.importDataFromFile(event)">
                        <button class="btn btn-secondary" onclick="document.getElementById('importFileInput').click()">
                            <i class="fas fa-file-import"></i> Nh·∫≠p t·ª´ IndexedDB backup
                        </button>
                        <button class="btn btn-primary" onclick="document.getElementById('importFileBackup').click()">
                            <i class="fas fa-file-upload"></i> Nh·∫≠p t·ª´ file backup (.json)
                        </button>
                    </div>
                </div>

                <!-- Migration Tools -->
                <div class="migration-panel">
                    <h3><i class="fas fa-exchange-alt"></i> C√¥ng c·ª• Migration</h3>
                    <div class="migration-controls">
                        <button class="btn btn-warning" onclick="app.checkMigrationStatus()">
                            <i class="fas fa-search"></i> Ki·ªÉm tra tr·∫°ng th√°i
                        </button>
                        <button class="btn btn-primary" onclick="app.verifyMigration()">
                            <i class="fas fa-check-circle"></i> X√°c minh d·ªØ li·ªáu
                        </button>
                    </div>
                    <div id="migrationStatusDisplay" class="migration-status">
                        <!-- Migration status will be displayed here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal x√°c nh·∫≠n x√≥a -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <h3>X√°c nh·∫≠n x√≥a</h3>
            <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t·ª´ v·ª±ng n√†y kh√¥ng?</p>
            <div class="modal-actions">
                <button id="confirmDelete" class="btn btn-danger">X√≥a</button>
                <button id="cancelDelete" class="btn btn-secondary">H·ªßy</button>
            </div>
        </div>
    </div>

    <!-- Modal nh·∫≠p li·ªáu ƒë·∫πp -->
    <div id="inputModal" class="modal">
        <div class="modal-content input-modal">
            <div class="modal-header">
                <h3 id="inputModalTitle">Nh·∫≠p th√¥ng tin</h3>
                <button class="modal-close" onclick="app.closeInputModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p id="inputModalMessage">Vui l√≤ng nh·∫≠p th√¥ng tin:</p>
                <div class="input-group">
                    <label id="inputModalLabel" for="inputModalField">Gi√° tr·ªã:</label>
                    <input type="text" id="inputModalField" class="input-field" placeholder="">
                    <div class="input-hint" id="inputModalHint"></div>
                </div>
            </div>
            <div class="modal-actions">
                <button id="inputModalConfirm" class="btn btn-primary">
                    <i class="fas fa-check"></i> X√°c nh·∫≠n
                </button>
                <button id="inputModalCancel" class="btn btn-secondary">
                    <i class="fas fa-times"></i> H·ªßy
                </button>
            </div>
        </div>
    </div>

    <!-- Load main app script first -->
    <script src="script.js"></script>
    
    <!-- Load IndexedDB modules -->
    <script src="src/js/core/indexeddb-storage.js"></script>
    <script src="src/js/core/migration.js"></script>
    <script src="src/js/core/storage-adapter.js"></script>
    
    <script>
        // Global app variable for onclick events
        let app = null;
        
        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ Initializing vocabulary app...');
            
            // Show migration banner
            showMigrationBanner('ƒêang kh·ªüi t·∫°o...', 10);
            
            try {
                // Check if IndexedDB is supported
                if (typeof IndexedDBStorage !== 'undefined' && IndexedDBStorage.isSupported()) {
                    // Initialize VocabularyApp with IndexedDB support
                    showMigrationBanner('ƒêang kh·ªüi t·∫°o IndexedDB...', 30);
                    app = new VocabularyAppIndexedDB();
                    console.log('‚úÖ IndexedDB App initialized');
                } else {
                    // Fallback to regular localStorage app
                    showMigrationBanner('S·ª≠ d·ª•ng localStorage...', 50);
                    app = new VocabularyApp();
                    console.log('‚úÖ localStorage App initialized');
                }
                
                // Wait for app to be ready
                let attempts = 0;
                while (attempts < 50) {
                    if (app.storage && app.storage.isReady) {
                        break; // IndexedDB ready
                    } else if (!app.storage) {
                        break; // localStorage app (no storage adapter)
                    }
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                
                hideMigrationBanner();
                
                // Setup event listeners
                setTimeout(() => {
                    setupEventListeners();
                    updateStorageDisplay();
                }, 100);
                
            } catch (error) {
                console.error('‚ùå App initialization failed:', error);
                showMigrationBanner('L·ªói kh·ªüi t·∫°o: ' + error.message, 100, 'error');
                
                // Fallback to basic localStorage app
                try {
                    console.log('üîÑ Falling back to localStorage app...');
                    app = new VocabularyApp();
                    setTimeout(() => {
                        setupEventListeners();
                        hideMigrationBanner();
                    }, 500);
                } catch (fallbackError) {
                    console.error('‚ùå Fallback also failed:', fallbackError);
                    showMigrationBanner('L·ªói nghi√™m tr·ªçng: ' + fallbackError.message, 100, 'error');
                }
            }
        });
        
        function showMigrationBanner(message, progress = 0, type = 'info') {
            const banner = document.getElementById('migrationBanner');
            if (banner) {
                const messageEl = document.getElementById('migrationMessage');
                const progressBar = document.getElementById('migrationProgressBar');
                
                if (messageEl) messageEl.textContent = message;
                if (progressBar) progressBar.style.width = progress + '%';
                banner.className = 'migration-banner ' + type;
                banner.style.display = 'block';
            }
        }
        
        function hideMigrationBanner() {
            const banner = document.getElementById('migrationBanner');
            if (banner) {
                banner.style.display = 'none';
            }
        }
        
        async function updateStorageDisplay() {
            if (!app) return;
            
            try {
                const storageTypeEl = document.getElementById('storageType');
                if (storageTypeEl) {
                    if (app.storage && app.storage.getStorageInfo) {
                        const storageInfo = await app.storage.getStorageInfo();
                        storageTypeEl.textContent = storageInfo.type === 'indexeddb' ? 'IDB' : 'LS';
                        storageTypeEl.title = storageInfo.type === 'indexeddb' ? 'IndexedDB' : 'localStorage';
                        
                        // Update detailed storage info if available
                        const storageInfoDisplay = document.getElementById('storageInfoDisplay');
                        if (storageInfoDisplay && storageInfo.stats) {
                            storageInfoDisplay.innerHTML = `
                                <div class="storage-stat">
                                    <span>Lo·∫°i l∆∞u tr·ªØ:</span>
                                    <span class="value">${storageInfo.type === 'indexeddb' ? 'IndexedDB' : 'localStorage'}</span>
                                </div>
                                <div class="storage-stat">
                                    <span>T·ª´ v·ª±ng:</span>
                                    <span class="value">${storageInfo.stats?.words || 0}</span>
                                </div>
                                <div class="storage-stat">
                                    <span>B√†i h·ªçc:</span>
                                    <span class="value">${storageInfo.stats?.lessons || 0}</span>
                                </div>
                                <div class="storage-stat">
                                    <span>Dung l∆∞·ª£ng ƒë√£ d√πng:</span>
                                    <span class="value">${(storageInfo.usage?.usedBytes / 1024).toFixed(1)} KB</span>
                                </div>
                                ${storageInfo.usage?.usagePercentage ? `
                                <div class="storage-stat">
                                    <span>T·ª∑ l·ªá s·ª≠ d·ª•ng:</span>
                                    <span class="value">${storageInfo.usage.usagePercentage}</span>
                                </div>
                                ` : ''}
                            `;
                        }
                        
                        // Update backups list if IndexedDB
                        if (storageInfo.type === 'indexeddb') {
                            await updateBackupsList();
                        }
                    } else {
                        // localStorage fallback
                        storageTypeEl.textContent = 'LS';
                        storageTypeEl.title = 'localStorage';
                        
                        const storageInfoDisplay = document.getElementById('storageInfoDisplay');
                        if (storageInfoDisplay) {
                            storageInfoDisplay.innerHTML = `
                                <div class="storage-stat">
                                    <span>Lo·∫°i l∆∞u tr·ªØ:</span>
                                    <span class="value">localStorage</span>
                                </div>
                                <div class="storage-stat">
                                    <span>T·ª´ v·ª±ng:</span>
                                    <span class="value">${app.words?.length || 0}</span>
                                </div>
                                <div class="storage-stat">
                                    <span>B√†i h·ªçc:</span>
                                    <span class="value">${app.lessons?.length || 0}</span>
                                </div>
                            `;
                        }
                    }
                }

                
            } catch (error) {
                console.error('Error updating storage display:', error);
            }
        }
        
        async function updateBackupsList() {
            const backupsList = document.getElementById('backupsList');
            if (!backupsList) return;
            
            try {
                if (app.storage && app.storage.getAllBackups) {
                    const backups = await app.storage.getAllBackups();
                    if (backups.length === 0) {
                        backupsList.innerHTML = '<p class="no-backups">Ch∆∞a c√≥ sao l∆∞u n√†o</p>';
                        return;
                    }
                    
                    backupsList.innerHTML = backups.map(backup => `
                        <div class="backup-item">
                            <div class="backup-info">
                                <div class="backup-desc">${backup.description}</div>
                                <div class="backup-date">${new Date(backup.timestamp).toLocaleString('vi-VN')}</div>
                            </div>
                            <div class="backup-actions">
                                <button class="btn btn-small btn-primary" onclick="app.restoreFromBackup(${backup.id})">
                                    <i class="fas fa-undo"></i> Kh√¥i ph·ª•c
                                </button>
                                <button class="btn btn-small btn-danger" onclick="app.deleteBackup(${backup.id})">
                                    <i class="fas fa-trash"></i> X√≥a
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    backupsList.innerHTML = '<p class="no-backups">T√≠nh nƒÉng backup ch·ªâ c√≥ v·ªõi IndexedDB</p>';
                }
                
            } catch (error) {
                backupsList.innerHTML = '<p class="error">L·ªói t·∫£i danh s√°ch sao l∆∞u</p>';
            }
        }
        
        // Backup and restore functions
        async function createBackup() {
            if (!app) {
                alert('·ª®ng d·ª•ng ch∆∞a s·∫µn s√†ng');
                return;
            }
            
            try {
                const description = await app.showInputModal({
                    title: 'üíæ T·∫°o Backup',
                    message: 'Nh·∫≠p m√¥ t·∫£ cho b·∫£n sao l∆∞u c·ªßa b·∫°n:',
                    label: 'M√¥ t·∫£ backup:',
                    type: 'text',
                    defaultValue: 'Backup th·ªß c√¥ng',
                    placeholder: 'VD: Backup tr∆∞·ªõc khi c·∫≠p nh·∫≠t...',
                    hint: 'M√¥ t·∫£ s·∫Ω gi√∫p b·∫°n nh·∫≠n bi·∫øt backup sau n√†y.'
                });
                if (!description) return;
                
                showMigrationBanner('ƒêang t·∫°o backup...', 10);
                
                if (app.createBackup) {
                    await app.createBackup(description);
                } else if (app.storage && app.storage.createBackup) {
                    await app.storage.createBackup(description);
                } else {
                    throw new Error('T√≠nh nƒÉng backup ch·ªâ c√≥ v·ªõi IndexedDB');
                }
                
                await updateBackupsList();
                await updateStorageDisplay();
                hideMigrationBanner();
                alert('T·∫°o backup th√†nh c√¥ng!');
            } catch (error) {
                hideMigrationBanner();
                if (error.message !== 'User cancelled') {
                    alert('L·ªói t·∫°o backup: ' + error.message);
                }
            }
        }
        
        function setupEventListeners() {
            console.log('Setting up event listeners...');
            
            // Setup tab navigation
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    if (app && app.switchTab) {
                        app.switchTab(tabName);
                        if (tabName === 'backup') {
                            updateStorageDisplay();
                        }
                    }
                });
            });
            
            // Setup form submissions
            const addWordForm = document.getElementById('addWordForm');
            if (addWordForm) {
                addWordForm.addEventListener('submit', (e) => {
                    if (app && app.addWord) app.addWord(e);
                });
            }
            
            const addLessonForm = document.getElementById('addLessonForm');
            if (addLessonForm) {
                addLessonForm.addEventListener('submit', (e) => {
                    if (app && app.addLesson) app.addLesson(e);
                });
            }
            
            // Setup review controls
            const startReview = document.getElementById('startReview');
            if (startReview) {
                startReview.addEventListener('click', () => {
                    if (app && app.startReview) app.startReview();
                });
            }
            
            const shuffleReview = document.getElementById('shuffleReview');
            if (shuffleReview) {
                shuffleReview.addEventListener('click', () => {
                    if (app && app.shuffleReview) app.shuffleReview();
                });
            }
            
            // Setup modal actions
            const confirmDelete = document.getElementById('confirmDelete');
            if (confirmDelete) {
                confirmDelete.addEventListener('click', () => {
                    if (app && app.confirmDelete) app.confirmDelete();
                });
            }
            
            const cancelDelete = document.getElementById('cancelDelete');
            if (cancelDelete) {
                cancelDelete.addEventListener('click', () => {
                    if (app && app.hideModal) app.hideModal();
                });
            }

            // Setup input modal actions
            const inputModalConfirm = document.getElementById('inputModalConfirm');
            if (inputModalConfirm) {
                inputModalConfirm.addEventListener('click', () => {
                    if (app && app.closeInputModal) app.closeInputModal(true);
                });
            }
            
            const inputModalCancel = document.getElementById('inputModalCancel');
            if (inputModalCancel) {
                inputModalCancel.addEventListener('click', () => {
                    if (app && app.closeInputModal) app.closeInputModal(false);
                });
            }
            
            // Setup search and filter
            const searchWord = document.getElementById('searchWord');
            if (searchWord) {
                searchWord.addEventListener('input', () => {
                    if (app && app.renderWordsList) app.renderWordsList();
                });
            }
            
            const filterLesson = document.getElementById('filterLesson');
            if (filterLesson) {
                filterLesson.addEventListener('change', () => {
                    if (app && app.renderWordsList) app.renderWordsList();
                });
            }
            
            const filterCategory = document.getElementById('filterCategory');
            if (filterCategory) {
                filterCategory.addEventListener('change', () => {
                    if (app && app.renderWordsList) app.renderWordsList();
                });
            }
            
            console.log('Event listeners setup complete');
        }
    </script>
    
    <style>
        .storage-badge {
            background: #4CAF50;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7em;
            margin-left: 10px;
        }
        
        .migration-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .migration-banner.error {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
        }
        
        .migration-content {
            flex: 1;
        }
        
        .migration-progress {
            background: rgba(255,255,255,0.2);
            height: 4px;
            border-radius: 2px;
            margin-top: 8px;
            overflow: hidden;
        }
        
        .progress-bar {
            background: white;
            height: 100%;
            transition: width 0.3s ease;
        }
        
        .storage-info-panel, .backup-panel, .import-panel, .migration-panel {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        
        .storage-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .storage-stat {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 4px;
        }
        
        .storage-stat .value {
            font-weight: bold;
            color: #2196F3;
        }
        
        .backup-controls, .import-controls, .migration-controls {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .file-backup-panel {
            background: #e8f5e8;
            border: 1px solid #4CAF50;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .file-backup-panel h3 {
            color: #2e7d32;
            margin-bottom: 10px;
        }

        .auto-backup-status h4 {
            margin: 0 0 10px 0;
            color: #1976d2;
        }

        .auto-backup-status p {
            margin: 5px 0;
        }
        
        .backups-container {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .backup-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        .backup-info .backup-desc {
            font-weight: bold;
        }
        
        .backup-info .backup-date {
            font-size: 0.9em;
            color: #666;
        }
        
        .backup-actions {
            display: flex;
            gap: 8px;
        }
        
        .no-backups, .error {
            text-align: center;
            padding: 20px;
            color: #666;
            font-style: italic;
        }
        
        .error {
            color: #f44336;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .migration-status {
            margin-top: 15px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 4px;
            min-height: 50px;
        }
        
        /* Input Modal Styles */
        .input-modal {
            max-width: 500px;
            width: 90%;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 15px;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        
        .modal-header h3 {
            margin: 0;
            color: #333;
            font-size: 1.4em;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }
        
        .modal-close:hover {
            background: #f5f5f5;
            color: #666;
        }
        
        .modal-body {
            margin-bottom: 25px;
        }
        
        .modal-body p {
            margin: 0 0 15px 0;
            color: #555;
            line-height: 1.5;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 0.95em;
        }
        
        .input-field {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e1e1;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }
        
        .input-field:invalid {
            border-color: #f44336;
        }
        
        .input-hint {
            margin-top: 8px;
            font-size: 0.85em;
            color: #666;
            font-style: italic;
        }
        
        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        .modal-actions .btn {
            min-width: 100px;
            padding: 10px 20px;
        }
        
        /* Animation for input modal */
        .input-modal.modal-content {
            animation: modalSlideIn 0.3s ease;
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .input-modal {
                width: 95%;
                margin: 10px;
            }
            
            .modal-actions {
                flex-direction: column;
            }
            
            .modal-actions .btn {
                width: 100%;
            }
        }
    </style>
</body>
</html> 