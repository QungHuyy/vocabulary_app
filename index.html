<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng dụng học từ vựng tiếng Anh - IndexedDB</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-book"></i> Học từ vựng tiếng Anh <span class="storage-badge">IndexedDB</span></h1>
            <div class="stats">
                <div class="stat-item">
                    <span class="stat-number" id="totalWords">0</span>
                    <span class="stat-label">Từ vựng</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="learnedWords">0</span>
                    <span class="stat-label">Đã học</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="accuracy">0%</span>
                    <span class="stat-label">Độ chính xác</span>
                </div>
                <div class="stat-item storage-info">
                    <span class="stat-number" id="storageType">...</span>
                    <span class="stat-label">Storage</span>
                </div>
            </div>
        </header>

        <!-- Migration Status Banner -->
        <div id="migrationBanner" class="migration-banner" style="display: none;">
            <div class="migration-content">
                <i class="fas fa-database"></i>
                <span id="migrationMessage">Đang khởi tạo...</span>
                <div class="migration-progress">
                    <div id="migrationProgressBar" class="progress-bar"></div>
                </div>
            </div>
        </div>

        <nav class="tab-nav">
            <button class="tab-btn active" data-tab="lessons">
                <i class="fas fa-folder"></i> Bài học
            </button>
            <button class="tab-btn" data-tab="add">
                <i class="fas fa-plus"></i> Thêm từ
            </button>
            <button class="tab-btn" data-tab="list">
                <i class="fas fa-list"></i> Danh sách
            </button>
            <button class="tab-btn" data-tab="quiz">
                <i class="fas fa-question-circle"></i> Luyện tập
            </button>
            <button class="tab-btn" data-tab="review">
                <i class="fas fa-eye"></i> Ôn tập
            </button>
            <button class="tab-btn" data-tab="backup">
                <i class="fas fa-shield-alt"></i> Sao lưu
            </button>
        </nav>

        <!-- Tab Bài học -->
        <div class="tab-content active" id="lessons-tab">
            <div class="card">
                <div class="lessons-header">
                    <h2><i class="fas fa-folder"></i> Quản lý bài học</h2>
                    <button class="btn btn-primary" onclick="app.showCreateLessonForm()">
                        <i class="fas fa-plus"></i> Tạo bài học mới
                    </button>
                </div>

                <!-- Form tạo bài học mới -->
                <div id="createLessonForm" class="lesson-form" style="display: none;">
                    <h3><i class="fas fa-plus-circle"></i> Tạo bài học mới</h3>
                    <form id="addLessonForm">
                        <div class="form-group">
                            <label for="lessonName">Tên bài học:</label>
                            <input type="text" id="lessonName" required placeholder="VD: Gia đình và bạn bè">
                        </div>
                        <div class="form-group">
                            <label for="lessonDescription">Mô tả (tùy chọn):</label>
                            <textarea id="lessonDescription" placeholder="Mô tả ngắn về bài học này..." rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="lessonColor">Màu chủ đề:</label>
                            <select id="lessonColor">
                                <option value="blue">Xanh dương</option>
                                <option value="green">Xanh lá</option>
                                <option value="purple">Tím</option>
                                <option value="orange">Cam</option>
                                <option value="red">Đỏ</option>
                                <option value="pink">Hồng</option>
                            </select>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Tạo bài học
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="app.hideCreateLessonForm()">
                                <i class="fas fa-times"></i> Hủy
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Danh sách bài học -->
                <div id="lessonsList" class="lessons-list"></div>

                <!-- Bài học hiện tại -->
                <div id="currentLessonInfo" class="current-lesson-info">
                    <div class="current-lesson-card">
                        <h3><i class="fas fa-book-open"></i> Bài học hiện tại</h3>
                        <div id="currentLessonDisplay"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Thêm từ vựng -->
        <div class="tab-content" id="add-tab">
            <div class="card">
                <h2><i class="fas fa-plus-circle"></i> Thêm từ vựng mới</h2>
                <div id="currentLessonSelector" class="lesson-selector">
                    <label for="selectedLesson">Thêm vào bài học:</label>
                    <select id="selectedLesson">
                        <option value="">Chọn bài học...</option>
                    </select>
                </div>
                <form id="addWordForm">
                    <div class="form-group">
                        <label for="englishWord">Từ tiếng Anh:</label>
                        <div class="input-with-button">
                            <div class="autocomplete-container">
                                <input type="text" id="englishWord" required placeholder="VD: beautiful" autocomplete="off">
                                <div class="autocomplete-suggestions" id="englishSuggestions"></div>
                            </div>
                            <button type="button" class="btn-pronunciation" onclick="app.speakWord(document.getElementById('englishWord').value)" title="Phát âm">
                                <i class="fas fa-volume-up"></i>
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="vietnameseMeaning">Nghĩa tiếng Việt:</label>
                        <div class="translation-container">
                            <input type="text" id="vietnameseMeaning" required placeholder="VD: xinh đẹp">
                            <div class="translation-status" id="translationStatus"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="example">Ví dụ (tùy chọn):</label>
                        <input type="text" id="example" placeholder="VD: She is very beautiful">
                    </div>
                    <div class="form-group">
                        <label for="category">Danh mục:</label>
                        <select id="category">
                            <option value="general">Tổng quát</option>
                            <option value="adjective">Tính từ</option>
                            <option value="noun">Danh từ</option>
                            <option value="verb">Động từ</option>
                            <option value="adverb">Trạng từ</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Lưu từ vựng
                    </button>
                </form>
            </div>
        </div>

        <!-- Tab Danh sách từ vựng -->
        <div class="tab-content" id="list-tab">
            <div class="card">
                <div class="list-header">
                    <h2><i class="fas fa-list"></i> Danh sách từ vựng</h2>
                    <div class="search-filter">
                        <select id="filterLesson">
                            <option value="">Tất cả bài học</option>
                        </select>
                        <input type="text" id="searchWord" placeholder="Tìm kiếm từ vựng...">
                        <select id="filterCategory">
                            <option value="">Tất cả danh mục</option>
                            <option value="general">Tổng quát</option>
                            <option value="adjective">Tính từ</option>
                            <option value="noun">Danh từ</option>
                            <option value="verb">Động từ</option>
                            <option value="adverb">Trạng từ</option>
                        </select>
                    </div>
                </div>
                <div id="wordsList" class="words-list"></div>
            </div>
        </div>

        <!-- Tab Luyện tập -->
        <div class="tab-content" id="quiz-tab">
            <div class="card">
                <div class="practice-header">
                    <h2><i class="fas fa-dumbbell"></i> Luyện tập từ vựng</h2>
                    <div class="practice-mode-selector">
                        <h3>Chọn chế độ luyện tập:</h3>
                        <div class="practice-modes">
                            <div class="practice-mode-card" onclick="app.selectPracticeMode('quiz')">
                                <i class="fas fa-question-circle"></i>
                                <h4>Quiz</h4>
                                <p>Trắc nghiệm tùy chỉnh</p>
                            </div>
                            <div class="practice-mode-card" onclick="app.selectPracticeMode('flashcards')">
                                <i class="fas fa-clone"></i>
                                <h4>Flashcards</h4>
                                <p>Lật thẻ từ vựng</p>
                            </div>
                            <div class="practice-mode-card" onclick="app.selectPracticeMode('spelling')">
                                <i class="fas fa-spell-check"></i>
                                <h4>Spelling Test</h4>
                                <p>Kiểm tra chính tả</p>
                            </div>
                            <div class="practice-mode-card" onclick="app.selectPracticeMode('matching')">
                                <i class="fas fa-puzzle-piece"></i>
                                <h4>Matching Game</h4>
                                <p>Ghép từ theo ván</p>
                            </div>
                            <div class="practice-mode-card" onclick="app.selectPracticeMode('speed')">
                                <i class="fas fa-bolt"></i>
                                <h4>Speed Challenge</h4>
                                <p>Thử thách tốc độ</p>
                            </div>
                            <div class="practice-mode-card" onclick="app.selectPracticeMode('listening')">
                                <i class="fas fa-headphones"></i>
                                <h4>Listening Practice</h4>
                                <p>Luyện nghe tùy chỉnh</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dynamic Practice Content -->
                <div id="practiceContainer" style="display: none;"></div>
            </div>
        </div>

        <!-- Tab Ôn tập -->
        <div class="tab-content" id="review-tab">
            <div class="card">
                <h2><i class="fas fa-eye"></i> Ôn tập từ vựng</h2>
                
                <!-- Chọn bài học để ôn tập -->
                <div class="review-lesson-selector">
                    <h3><i class="fas fa-check-square"></i> Chọn bài học để ôn tập</h3>
                    <div class="lesson-checkboxes" id="reviewLessonCheckboxes">
                        <!-- Checkboxes will be populated by JavaScript -->
                    </div>
                    <div class="select-all-controls">
                        <button type="button" class="btn btn-small btn-primary" onclick="app.selectAllLessons()">
                            <i class="fas fa-check-double"></i> Chọn tất cả
                        </button>
                        <button type="button" class="btn btn-small btn-secondary" onclick="app.deselectAllLessons()">
                            <i class="fas fa-times"></i> Bỏ chọn tất cả
                        </button>
                    </div>
                </div>

                <div class="review-controls">
                    <button id="startReview" class="btn btn-secondary">
                        <i class="fas fa-play"></i> Bắt đầu ôn tập
                    </button>
                    <button id="shuffleReview" class="btn btn-secondary">
                        <i class="fas fa-random"></i> Xáo trộn
                    </button>
                </div>
                <div id="reviewContent" class="review-content">
                    <p>Chọn bài học và nhấn "Bắt đầu ôn tập" để xem lại từ vựng đã học</p>
                </div>
            </div>
        </div>

        <!-- Tab Sao lưu -->
        <div class="tab-content" id="backup-tab">
            <div class="card">
                <h2><i class="fas fa-shield-alt"></i> Sao lưu & Phục hồi dữ liệu</h2>
                
                <!-- Storage Info -->
                <div class="storage-info-panel">
                    <h3><i class="fas fa-info-circle"></i> Thông tin lưu trữ</h3>
                    <div id="storageInfoDisplay" class="storage-stats">
                        <div class="loading">Đang tải...</div>
                    </div>
                </div>

                <!-- Backup Management -->
                <div class="backup-panel">
                    <h3><i class="fas fa-download"></i> Tạo sao lưu</h3>
                    <div class="backup-controls">
                        <button class="btn btn-primary" onclick="app.createManualBackup()">
                            <i class="fas fa-save"></i> Tạo sao lưu ngay
                        </button>
                        <button class="btn btn-secondary" onclick="app.exportData()">
                            <i class="fas fa-file-export"></i> Xuất file JSON
                        </button>
                    </div>
                    
                    <div class="backup-list">
                        <h4>Danh sách sao lưu tự động:</h4>
                        <div id="backupsList" class="backups-container">
                            <div class="loading">Đang tải...</div>
                        </div>
                    </div>
                </div>

                <!-- File Backup for GitHub Pages -->
                <div class="file-backup-panel">
                    <h3><i class="fas fa-file-download"></i> Backup File (GitHub Pages)</h3>
                    <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">
                        <i class="fas fa-info-circle"></i> Dành cho GitHub Pages - tải file backup để tránh mất dữ liệu
                    </p>
                    <div class="backup-controls">
                        <button class="btn btn-success" onclick="app.exportDataToFile()">
                            <i class="fas fa-download"></i> Tải file backup (.json)
                        </button>
                        <button class="btn btn-info" onclick="app.createAutoBackup()">
                            <i class="fas fa-sync"></i> Tạo backup tự động
                        </button>
                    </div>
                    
                    <div class="auto-backup-status" style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                        <h4><i class="fas fa-shield-alt"></i> Trạng thái Auto-backup:</h4>
                        <p id="autoBackupStatus">✅ IndexedDB auto-backup đang hoạt động (mỗi 10 phút)</p>
                        <p style="font-size: 0.85em; color: #666;">
                            • <strong>IndexedDB:</strong> Backup tự động mỗi 10 phút và khi thoát trang<br>
                            • <strong>Lưu trữ:</strong> Backup trong database IndexedDB (không mất khi F5)<br>
                            • <strong>Dự phòng:</strong> Giữ 5 bản backup auto gần nhất<br>
                            • <strong>File backup:</strong> Tải file .json để backup lâu dài
                        </p>
                    </div>
                </div>

                <!-- Import Data -->
                <div class="import-panel">
                    <h3><i class="fas fa-upload"></i> Nhập dữ liệu</h3>
                    <div class="import-controls">
                        <input type="file" id="importFileInput" accept=".json" style="display: none;" onchange="app.importData(event)">
                        <input type="file" id="importFileBackup" accept=".json" style="display: none;" onchange="app.importDataFromFile(event)">
                        <button class="btn btn-secondary" onclick="document.getElementById('importFileInput').click()">
                            <i class="fas fa-file-import"></i> Nhập từ IndexedDB backup
                        </button>
                        <button class="btn btn-primary" onclick="document.getElementById('importFileBackup').click()">
                            <i class="fas fa-file-upload"></i> Nhập từ file backup (.json)
                        </button>
                    </div>
                </div>

                <!-- Migration Tools -->
                <div class="migration-panel">
                    <h3><i class="fas fa-exchange-alt"></i> Công cụ Migration</h3>
                    <div class="migration-controls">
                        <button class="btn btn-warning" onclick="app.checkMigrationStatus()">
                            <i class="fas fa-search"></i> Kiểm tra trạng thái
                        </button>
                        <button class="btn btn-primary" onclick="app.verifyMigration()">
                            <i class="fas fa-check-circle"></i> Xác minh dữ liệu
                        </button>
                    </div>
                    <div id="migrationStatusDisplay" class="migration-status">
                        <!-- Migration status will be displayed here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal xác nhận xóa -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <h3>Xác nhận xóa</h3>
            <p>Bạn có chắc chắn muốn xóa từ vựng này không?</p>
            <div class="modal-actions">
                <button id="confirmDelete" class="btn btn-danger">Xóa</button>
                <button id="cancelDelete" class="btn btn-secondary">Hủy</button>
            </div>
        </div>
    </div>

    <!-- Modal nhập liệu đẹp -->
    <div id="inputModal" class="modal">
        <div class="modal-content input-modal">
            <div class="modal-header">
                <h3 id="inputModalTitle">Nhập thông tin</h3>
                <button class="modal-close" onclick="app.closeInputModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p id="inputModalMessage">Vui lòng nhập thông tin:</p>
                <div class="input-group">
                    <label id="inputModalLabel" for="inputModalField">Giá trị:</label>
                    <input type="text" id="inputModalField" class="input-field" placeholder="">
                    <div class="input-hint" id="inputModalHint"></div>
                </div>
            </div>
            <div class="modal-actions">
                <button id="inputModalConfirm" class="btn btn-primary">
                    <i class="fas fa-check"></i> Xác nhận
                </button>
                <button id="inputModalCancel" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Hủy
                </button>
            </div>
        </div>
    </div>

    <!-- Load main app script first -->
    <script src="script.js"></script>
    
    <!-- Load IndexedDB modules -->
    <script src="src/js/core/indexeddb-storage.js"></script>
    <script src="src/js/core/migration.js"></script>
    <script src="src/js/core/storage-adapter.js"></script>
    
    <script>
        // Global app variable for onclick events
        let app = null;
        
        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 Initializing vocabulary app...');
            
            // Show migration banner
            showMigrationBanner('Đang khởi tạo...', 10);
            
            try {
                // Check if IndexedDB is supported
                if (typeof IndexedDBStorage !== 'undefined' && IndexedDBStorage.isSupported()) {
                    // Initialize VocabularyApp with IndexedDB support
                    showMigrationBanner('Đang khởi tạo IndexedDB...', 30);
                    app = new VocabularyAppIndexedDB();
                    console.log('✅ IndexedDB App initialized');
                } else {
                    // Fallback to regular localStorage app
                    showMigrationBanner('Sử dụng localStorage...', 50);
                    app = new VocabularyApp();
                    console.log('✅ localStorage App initialized');
                }
                
                // Wait for app to be ready
                let attempts = 0;
                while (attempts < 50) {
                    if (app.storage && app.storage.isReady) {
                        break; // IndexedDB ready
                    } else if (!app.storage) {
                        break; // localStorage app (no storage adapter)
                    }
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                
                hideMigrationBanner();
                
                // Setup event listeners
                setTimeout(() => {
                    setupEventListeners();
                    updateStorageDisplay();
                }, 100);
                
            } catch (error) {
                console.error('❌ App initialization failed:', error);
                showMigrationBanner('Lỗi khởi tạo: ' + error.message, 100, 'error');
                
                // Fallback to basic localStorage app
                try {
                    console.log('🔄 Falling back to localStorage app...');
                    app = new VocabularyApp();
                    setTimeout(() => {
                        setupEventListeners();
                        hideMigrationBanner();
                    }, 500);
                } catch (fallbackError) {
                    console.error('❌ Fallback also failed:', fallbackError);
                    showMigrationBanner('Lỗi nghiêm trọng: ' + fallbackError.message, 100, 'error');
                }
            }
        });
        
        function showMigrationBanner(message, progress = 0, type = 'info') {
            const banner = document.getElementById('migrationBanner');
            if (banner) {
                const messageEl = document.getElementById('migrationMessage');
                const progressBar = document.getElementById('migrationProgressBar');
                
                if (messageEl) messageEl.textContent = message;
                if (progressBar) progressBar.style.width = progress + '%';
                banner.className = 'migration-banner ' + type;
                banner.style.display = 'block';
            }
        }
        
        function hideMigrationBanner() {
            const banner = document.getElementById('migrationBanner');
            if (banner) {
                banner.style.display = 'none';
            }
        }
        
        async function updateStorageDisplay() {
            if (!app) return;
            
            try {
                const storageTypeEl = document.getElementById('storageType');
                if (storageTypeEl) {
                    if (app.storage && app.storage.getStorageInfo) {
                        const storageInfo = await app.storage.getStorageInfo();
                        storageTypeEl.textContent = storageInfo.type === 'indexeddb' ? 'IDB' : 'LS';
                        storageTypeEl.title = storageInfo.type === 'indexeddb' ? 'IndexedDB' : 'localStorage';
                        
                        // Update detailed storage info if available
                        const storageInfoDisplay = document.getElementById('storageInfoDisplay');
                        if (storageInfoDisplay && storageInfo.stats) {
                            storageInfoDisplay.innerHTML = `
                                <div class="storage-stat">
                                    <span>Loại lưu trữ:</span>
                                    <span class="value">${storageInfo.type === 'indexeddb' ? 'IndexedDB' : 'localStorage'}</span>
                                </div>
                                <div class="storage-stat">
                                    <span>Từ vựng:</span>
                                    <span class="value">${storageInfo.stats?.words || 0}</span>
                                </div>
                                <div class="storage-stat">
                                    <span>Bài học:</span>
                                    <span class="value">${storageInfo.stats?.lessons || 0}</span>
                                </div>
                                <div class="storage-stat">
                                    <span>Dung lượng đã dùng:</span>
                                    <span class="value">${(storageInfo.usage?.usedBytes / 1024).toFixed(1)} KB</span>
                                </div>
                                ${storageInfo.usage?.usagePercentage ? `
                                <div class="storage-stat">
                                    <span>Tỷ lệ sử dụng:</span>
                                    <span class="value">${storageInfo.usage.usagePercentage}</span>
                                </div>
                                ` : ''}
                            `;
                        }
                        
                        // Update backups list if IndexedDB
                        if (storageInfo.type === 'indexeddb') {
                            await updateBackupsList();
                        }
                    } else {
                        // localStorage fallback
                        storageTypeEl.textContent = 'LS';
                        storageTypeEl.title = 'localStorage';
                        
                        const storageInfoDisplay = document.getElementById('storageInfoDisplay');
                        if (storageInfoDisplay) {
                            storageInfoDisplay.innerHTML = `
                                <div class="storage-stat">
                                    <span>Loại lưu trữ:</span>
                                    <span class="value">localStorage</span>
                                </div>
                                <div class="storage-stat">
                                    <span>Từ vựng:</span>
                                    <span class="value">${app.words?.length || 0}</span>
                                </div>
                                <div class="storage-stat">
                                    <span>Bài học:</span>
                                    <span class="value">${app.lessons?.length || 0}</span>
                                </div>
                            `;
                        }
                    }
                }

                
            } catch (error) {
                console.error('Error updating storage display:', error);
            }
        }
        
        async function updateBackupsList() {
            const backupsList = document.getElementById('backupsList');
            if (!backupsList) return;
            
            try {
                if (app.storage && app.storage.getAllBackups) {
                    const backups = await app.storage.getAllBackups();
                    if (backups.length === 0) {
                        backupsList.innerHTML = '<p class="no-backups">Chưa có sao lưu nào</p>';
                        return;
                    }
                    
                    backupsList.innerHTML = backups.map(backup => `
                        <div class="backup-item">
                            <div class="backup-info">
                                <div class="backup-desc">${backup.description}</div>
                                <div class="backup-date">${new Date(backup.timestamp).toLocaleString('vi-VN')}</div>
                            </div>
                            <div class="backup-actions">
                                <button class="btn btn-small btn-primary" onclick="app.restoreFromBackup(${backup.id})">
                                    <i class="fas fa-undo"></i> Khôi phục
                                </button>
                                <button class="btn btn-small btn-danger" onclick="app.deleteBackup(${backup.id})">
                                    <i class="fas fa-trash"></i> Xóa
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    backupsList.innerHTML = '<p class="no-backups">Tính năng backup chỉ có với IndexedDB</p>';
                }
                
            } catch (error) {
                backupsList.innerHTML = '<p class="error">Lỗi tải danh sách sao lưu</p>';
            }
        }
        
        // Backup and restore functions
        async function createBackup() {
            if (!app) {
                alert('Ứng dụng chưa sẵn sàng');
                return;
            }
            
            try {
                const description = await app.showInputModal({
                    title: '💾 Tạo Backup',
                    message: 'Nhập mô tả cho bản sao lưu của bạn:',
                    label: 'Mô tả backup:',
                    type: 'text',
                    defaultValue: 'Backup thủ công',
                    placeholder: 'VD: Backup trước khi cập nhật...',
                    hint: 'Mô tả sẽ giúp bạn nhận biết backup sau này.'
                });
                if (!description) return;
                
                showMigrationBanner('Đang tạo backup...', 10);
                
                if (app.createBackup) {
                    await app.createBackup(description);
                } else if (app.storage && app.storage.createBackup) {
                    await app.storage.createBackup(description);
                } else {
                    throw new Error('Tính năng backup chỉ có với IndexedDB');
                }
                
                await updateBackupsList();
                await updateStorageDisplay();
                hideMigrationBanner();
                alert('Tạo backup thành công!');
            } catch (error) {
                hideMigrationBanner();
                if (error.message !== 'User cancelled') {
                    alert('Lỗi tạo backup: ' + error.message);
                }
            }
        }
        
        function setupEventListeners() {
            console.log('Setting up event listeners...');
            
            // Setup tab navigation
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    if (app && app.switchTab) {
                        app.switchTab(tabName);
                        if (tabName === 'backup') {
                            updateStorageDisplay();
                        }
                    }
                });
            });
            
            // Setup form submissions
            const addWordForm = document.getElementById('addWordForm');
            if (addWordForm) {
                addWordForm.addEventListener('submit', (e) => {
                    if (app && app.addWord) app.addWord(e);
                });
            }
            
            const addLessonForm = document.getElementById('addLessonForm');
            if (addLessonForm) {
                addLessonForm.addEventListener('submit', (e) => {
                    if (app && app.addLesson) app.addLesson(e);
                });
            }
            
            // Setup review controls
            const startReview = document.getElementById('startReview');
            if (startReview) {
                startReview.addEventListener('click', () => {
                    if (app && app.startReview) app.startReview();
                });
            }
            
            const shuffleReview = document.getElementById('shuffleReview');
            if (shuffleReview) {
                shuffleReview.addEventListener('click', () => {
                    if (app && app.shuffleReview) app.shuffleReview();
                });
            }
            
            // Setup modal actions
            const confirmDelete = document.getElementById('confirmDelete');
            if (confirmDelete) {
                confirmDelete.addEventListener('click', () => {
                    if (app && app.confirmDelete) app.confirmDelete();
                });
            }
            
            const cancelDelete = document.getElementById('cancelDelete');
            if (cancelDelete) {
                cancelDelete.addEventListener('click', () => {
                    if (app && app.hideModal) app.hideModal();
                });
            }

            // Setup input modal actions
            const inputModalConfirm = document.getElementById('inputModalConfirm');
            if (inputModalConfirm) {
                inputModalConfirm.addEventListener('click', () => {
                    if (app && app.closeInputModal) app.closeInputModal(true);
                });
            }
            
            const inputModalCancel = document.getElementById('inputModalCancel');
            if (inputModalCancel) {
                inputModalCancel.addEventListener('click', () => {
                    if (app && app.closeInputModal) app.closeInputModal(false);
                });
            }
            
            // Setup search and filter
            const searchWord = document.getElementById('searchWord');
            if (searchWord) {
                searchWord.addEventListener('input', () => {
                    if (app && app.renderWordsList) app.renderWordsList();
                });
            }
            
            const filterLesson = document.getElementById('filterLesson');
            if (filterLesson) {
                filterLesson.addEventListener('change', () => {
                    if (app && app.renderWordsList) app.renderWordsList();
                });
            }
            
            const filterCategory = document.getElementById('filterCategory');
            if (filterCategory) {
                filterCategory.addEventListener('change', () => {
                    if (app && app.renderWordsList) app.renderWordsList();
                });
            }
            
            console.log('Event listeners setup complete');
        }
    </script>
    
    <style>
        .storage-badge {
            background: #4CAF50;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7em;
            margin-left: 10px;
        }
        
        .migration-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .migration-banner.error {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
        }
        
        .migration-content {
            flex: 1;
        }
        
        .migration-progress {
            background: rgba(255,255,255,0.2);
            height: 4px;
            border-radius: 2px;
            margin-top: 8px;
            overflow: hidden;
        }
        
        .progress-bar {
            background: white;
            height: 100%;
            transition: width 0.3s ease;
        }
        
        .storage-info-panel, .backup-panel, .import-panel, .migration-panel {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        
        .storage-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .storage-stat {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 4px;
        }
        
        .storage-stat .value {
            font-weight: bold;
            color: #2196F3;
        }
        
        .backup-controls, .import-controls, .migration-controls {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .file-backup-panel {
            background: #e8f5e8;
            border: 1px solid #4CAF50;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .file-backup-panel h3 {
            color: #2e7d32;
            margin-bottom: 10px;
        }

        .auto-backup-status h4 {
            margin: 0 0 10px 0;
            color: #1976d2;
        }

        .auto-backup-status p {
            margin: 5px 0;
        }
        
        .backups-container {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .backup-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        .backup-info .backup-desc {
            font-weight: bold;
        }
        
        .backup-info .backup-date {
            font-size: 0.9em;
            color: #666;
        }
        
        .backup-actions {
            display: flex;
            gap: 8px;
        }
        
        .no-backups, .error {
            text-align: center;
            padding: 20px;
            color: #666;
            font-style: italic;
        }
        
        .error {
            color: #f44336;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .migration-status {
            margin-top: 15px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 4px;
            min-height: 50px;
        }
        
        /* Input Modal Styles */
        .input-modal {
            max-width: 500px;
            width: 90%;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 15px;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        
        .modal-header h3 {
            margin: 0;
            color: #333;
            font-size: 1.4em;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }
        
        .modal-close:hover {
            background: #f5f5f5;
            color: #666;
        }
        
        .modal-body {
            margin-bottom: 25px;
        }
        
        .modal-body p {
            margin: 0 0 15px 0;
            color: #555;
            line-height: 1.5;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 0.95em;
        }
        
        .input-field {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e1e1;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }
        
        .input-field:invalid {
            border-color: #f44336;
        }
        
        .input-hint {
            margin-top: 8px;
            font-size: 0.85em;
            color: #666;
            font-style: italic;
        }
        
        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        .modal-actions .btn {
            min-width: 100px;
            padding: 10px 20px;
        }
        
        /* Animation for input modal */
        .input-modal.modal-content {
            animation: modalSlideIn 0.3s ease;
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .input-modal {
                width: 95%;
                margin: 10px;
            }
            
            .modal-actions {
                flex-direction: column;
            }
            
            .modal-actions .btn {
                width: 100%;
            }
        }
    </style>
</body>
</html> 